<!DOCTYPE html>
<html>

<head>
    <title>Detail Submission Form</title>
    <script>
        const Email = null;
        function validateForm() {
            var name = document.forms["detailForm"]["name"].value;
            var email = document.forms["detailForm"]["email"].value;

            if (name == "" || email == "") {
                alert("Please fill out all required fields");
                return false;
            }
            if (!validateEmail(email)) {
                alert("Please enter a valid email address");
                return false;
            }

            return true;
        }

        function validateEmail(email) {
            var re = /\S+@\S+\.\S+/;
            return re.test(email);
        }

        const fetchURL = async (url) => {
            const resp = await fetch(url);
            return await resp.json();
        };



        //setEmail function will trigger when submit button is clicked it would save the email in database
        function setEmail() {
            var data = JSON.stringify({
                "email": document.getElementById("email").value,

            });

            let xmlHttpReq = new XMLHttpRequest();
            xmlHttpReq.onreadystatechange = function () {
                if (xmlHttpReq.readyState === XMLHttpRequest.DONE) {
                    console.log(JSON.parse(xmlHttpReq.responseText));
                    getEmail();
                    // handle the response
                }
            }
            xmlHttpReq.open("POST", `https://us-east-1.aws.data.mongodb-api.com/app/application-0-awqqz/endpoint/setEmail`, false);
            xmlHttpReq.send(data);

        }

        function getEmail() {
            var array = new Array();
            let uri = "https://us-east-1.aws.data.mongodb-api.com/app/application-0-awqqz/endpoint/getEmail";
            /*  fetchURL(uri).then((data) => {
                  for (let i in data[0]["data"]) {
                      array.push(data[0]["data"][i]["email"]);
                  }
                  console.log("array" + array)
                  console.log("Array size: " + array.length)
                  for (let i in array) {
                      if ("abc@gmail.com".includes(array[i])) {
                          console.log("true" + array[i])
                      } else {
                          console.log("false" + array[i])
      
                          const salt = Math.random().toString(36).substring(2, 15);
                          const stringToHash = array[i] + salt;
                          console.log("email+saltValue" + stringToHash)
                          var hexHash = CryptoJS.SHA256(stringToHash)
                          const uniqueUrl = "https://example.com/user/".concat(hexHash);
                          console.log(uniqueUrl)
                      }
                  }
              });*/
            fetch(uri)
                .then(function (response) {
                    return response.json();
                })
                .then(function (data) {
                    for (let key in data) {
                    //    console.log(data[key]["email2"]); // print the value for each key
                        array.push(data[key]["email"]);
                    }


                    const salt = Math.random().toString(36).substring(2, 15);
                    const stringToHash = array[array.length - 1] + salt;
                    console.log("email+saltValue" + stringToHash)
                    var hexHash = CryptoJS.SHA256(stringToHash)
                    const uniqueUrl = "https://gem-codeeditor.com/user/".concat(hexHash);
                    console.log(uniqueUrl)
                    document.getElementById("output").innerHTML = uniqueUrl;


                    // console.log(array[array.length-1]); // print the parsed data
                });

        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/sha256.js"></script>
</head>

<body>
    <form name="detailForm" onsubmit="return validateForm()" method="post">
        <label for="name">Name:</label>
        <input type="text" id="name" name="name" required><br><br>

        <label for="email">Email:</label>
        <input type="email" id="email" name="email" required><br><br>

      <label for="message">Link:</label>
      <!--<textarea id="message" name="message"></textarea><br>-->


      <p id="output"></p>

        <button type="button" onclick="setEmail()">Submit</button>
    </form>
</body>

</html>