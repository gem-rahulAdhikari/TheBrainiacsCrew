<!DOCTYPE html>
<html>
  <head>
    <title>index</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="{{ url_for('static',filename='index_updated.css') }}"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="{{ url_for('static',filename='Scretkey.css') }}"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/sha256.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.3/awesomplete.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.3/awesomplete.min.js"></script>
  </head>
  <body>
    <div id="secretKeyModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <p>Enter secret key:</p>
        <input type="password" id="secretKeyInput" />
        <button id="submitSecretKey">Submit</button>
      </div>
    </div>
    <div id="content" class="hidden">
      <nav>
        <div>
          <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" />
        </div>
        <div style="border: 2px solid black">
          <img
            class="profile-image"
            id="profile"
            src="{{ url_for('static', filename='profile.webp') }}"
            alt="Profile Image"
            onclick="toggleProfilePopup()"
          />
          <div id="profilePopup" style="display: none" class="popup">
            <div id="profileContent"></div>
          </div>
        </div>
      </nav>
      <div id="sidebar">
        <div class="hamburger-wrapper">
          <div class="hamburger-icon">
            <i class="fas fa-bars"></i>
          </div>
        </div>
        <div class="numbers-container" style="display: none"></div>
      </div>

      <div id="content-container">
        <div id="inner-div">
          <div id="heading-container">
            <h2 style="font-size: 20px" id="questionHeading">Question</h2>
          </div>
          <div id="questionStatement">
            <!-- Question statement content goes here -->
            Question statement
          </div>

          <h4 style="margin-top: 20px; font-size: 20px">Sample Result 1</h4>
          <div
            class="sample-container"
            id="sample_input"
            style="min-height: 50px"
          >
            <!-- Initial content or placeholder for sample input goes here -->
            Sample input and output
          </div>

          <h4 style="font-size: 20px; margin-top: 20px">Sample Result 2</h4>
          <div
            class="sample-container"
            id="sample_output"
            style="min-height: 50px"
          >
            <!-- Initial content or placeholder for sample output goes here -->
            Sample input and output
          </div>
        </div>
        <div class="code-editor-wrapper">
          <div class="icons-container" style="border: 1px solid black">
            {% if session['role']!='Admin' %}
            <div
              id="language-dropdown"
              style="transform: translate(-275%, 10%)"
            >
              <select id="dropdown" class="language">
                <option value="">Select Languages</option>
                <option value="71">Python</option>
                <option value="76">C++</option>
                <option value="62">Java</option>
                <option value="Selenium">Selenium</option>
              </select>
            </div>
            {% elif session['role']=='Admin' %}
            <div id="language-dropdown">
              <select id="dropdown" class="language">
                <option value="">Select Languages</option>
                <option value="71">Python</option>
                <option value="76">C++</option>
                <option value="62">Java</option>
                <option value="Selenium">Selenium</option>
              </select>
            </div>
            {% endif %} {% if session['role']=='Admin' %}
            <div id="submission">
              <select id="dropdown1" class="language">
                <option value="">Submissions</option>
              </select>
            </div>
            {% endif %}
            <i class="fas fa-refresh" id="reset"></i>
            <i
              class="fa-solid fa-expand"
              id="expand-icon"
              onclick="expandTextarea()"
            ></i>
            <i
              class="fa-solid fa-compress"
              id="compress-icon"
              style="display: none"
            ></i>
          </div>
          <div id="textarea-container">
            <div id="editor-container">
              <form method="POST" action="/submit">
                {% if session['role']=='Admin' %}
                <textarea
                  class="form-control"
                  readonly
                  placeholder="Write Here....."
                  id="code_input"
                  name="code_input"
                  onkeydown="if(event.keyCode===9){
                  var v=this.value,s=this.selectionStart,e=this.selectionEnd;this.value=v.substring(0, s)+'\t'+v.substring(e);this.selectionStart=this.selectionEnd=s+1;return false;
              }"
                ></textarea>
                {% else %}
                <textarea
                  class="form-control"
                  placeholder="Write Here....."
                  id="code_input"
                  name="code_input"
                  onkeydown="if(event.keyCode===9){
                      var v=this.value,s=this.selectionStart,e=this.selectionEnd;this.value=v.substring(0, s)+'\t'+v.substring(e);this.selectionStart=this.selectionEnd=s+1;return false;
                  }"
                ></textarea>
                {% endif %}
              </form>
            </div>
            <i id="toggleIcon" class="fas fa-caret-down"></i>
            <div id="buttons-container">
              {% if session['role']=='Admin' %}
              <button
                type="button"
                class="btn"
                id="Runbtn"
                style="margin-right: 80px"
                onclick="disableButton()"
                disabled
              >
                Run
              </button>
              <button
                type="button"
                class="btn"
                id="Executebtn"
                onclick="disableButton()"
                disabled
              >
                Submit
              </button>
              {% else %}
              <button
                type="button"
                class="btn"
                id="Runbtn"
                style="margin-right: 80px"
              >
                Run
              </button>
              <button type="button" class="btn" id="Executebtn">Submit</button>
              {% endif %}
              <div id="textareas-container">
                <h4 id="inputHeading">Input</h4>
                {% if session['role']=='Admin' %}
                <textarea
                  id="inputTextarea"
                  readonly
                  style="margin-left: 20px"
                  name="input_area"
                  class="active"
                >
                </textarea>
                {% else %}
                <textarea
                  id="inputTextarea"
                  style="margin-left: 20px"
                  name="input_area"
                  class="active"
                >
                </textarea>
                {% endif %}
                <h4 id="outputHeading">Output</h4>
                <textarea
                  id="outputTextarea"
                  style="margin-left: 310px"
                  name="code_output"
                ></textarea>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
  <script>
    const secretKeyModal = document.getElementById("secretKeyModal");
    const secretKeyInput = document.getElementById("secretKeyInput");
    const submitSecretKeyButton = document.getElementById("submitSecretKey");
    const mainPage = document.querySelector(".hidden");
    const closeButton = document.querySelector(".close");
    const questionLink = document.getElementById("question-link");
    window.addEventListener("load", function () {
      var textarea = document.getElementById("code_input");
      textarea.value = "";
    });
    //In this we checking the Role based things
    var myValue = localStorage.getItem("role");
    if (myValue == "Admin") {
      console.log("this is admin");
      secretKeyModal.style.display = "none";
      document.getElementById("content").style.display = "block";
    } else {
      var sessionData = JSON.parse(localStorage.getItem("sessionData"));
      console.log("heloo");

      if (sessionStorage.getItem("secret") != null) {
        console.log("user is login");
        const secretKeyModal = document.getElementById("secretKeyModal");
        document.getElementById("content").style.display = "block";
        secretKeyModal.style.display = "none";
      } else {
        console.log("user is not login");
        const currentUrl = window.location.href;
        console.log(currentUrl);
        let UserKey = null;
        fetch(
          "https://us-east-1.aws.data.mongodb-api.com/app/application-0-awqqz/endpoint/getAdminTableDataWithoutFile"
        )
          .then((response) => response.json())
          .then((data) => {
            for (let i = 0; i < data.length; i++) {
              console.log("enter");
              const item = data[i];
              if (currentUrl === item.url) {
                UserKey = item.SecretKey;
                break;
              }
            }
            console.log(UserKey);
            secretKeyModal.style.display = "block";
            secretKeyInput.focus();
            submitSecretKeyButton.addEventListener("click", () => {
              const validation = secretKeyInput.value.trim();
              if (validation === UserKey) {
                sessionStorage.setItem("secret", UserKey);
                document.getElementById("content").style.display = "block";
                secretKeyModal.style.display = "none";
              } else {
                alert("Invalid secret key, please try again!");
              }
            });
          })
          .catch((error) => console.error(error));
      }
    }

    // Add event listener to the close button
    closeButton.addEventListener("click", () => {
      secretKeyModal.style.display = "none";
    });

    function disableButton() {
      const button = document.getElementById("Runbtn");
      button.disabled = true;
    }
  </script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-analytics.js";
    import {
      getDatabase,
      ref,
      onValue,
      set,
    } from "https://www.gstatic.com/firebasejs/10.3.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCTjZFh1R-HgF-TTspx3S3T2d7BOPjJnGM",
      authDomain: "flask-app-b27bb.firebaseapp.com",
      databaseURL: "https://flask-app-b27bb-default-rtdb.firebaseio.com",
      projectId: "flask-app-b27bb",
      storageBucket: "flask-app-b27bb.appspot.com",
      messagingSenderId: "643677151622",
      appId: "1:643677151622:web:ea58239d04fc0415e88c07",
      measurementId: "G-EZH5DP62QM",
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);

    const inputField = document.getElementById("code_input");

    // Reference to the Firebase Realtime Database
    const db = getDatabase();
    const dbRef = ref(db, "text");

    // Listen for changes in the database and update the input field
    onValue(dbRef, (snapshot) => {
      const data = snapshot.val();
      if (data) {
        inputField.value = data;
        console.log("hello");
        console.log("hello");
        console.log(inputField.value);
      }
    });

    inputField.addEventListener("input", () => {
      const text = inputField.value;
      set(ref(db, "text"), text)
        .then(() => {
          console.log("Data saved to Firebase:", text);
        })
        .catch((error) => {
          console.error("Error saving data to Firebase:", error);
        });
    });
  </script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
  <script
    src="https://kit.fontawesome.com/3fcbd0cded.js"
    crossorigin="anonymous"
  ></script>
  <script src="{{ url_for('static', filename='index_updated.js') }}"></script>
</html>
